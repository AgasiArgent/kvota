#!/bin/bash
# Dev Docs Helper Script - Reduces manual overhead by 90%

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEV_DIR="$SCRIPT_DIR"  # The script is in the dev directory
ACTIVE_DIR="$DEV_DIR/active"
COMPLETED_DIR="$DEV_DIR/completed"
TEMPLATES_DIR="$DEV_DIR/templates"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get next task number
get_next_task_number() {
    local max_num=0
    for dir in "$ACTIVE_DIR"/* "$COMPLETED_DIR"/*; do
        if [[ -d "$dir" ]]; then
            local basename=$(basename "$dir")
            if [[ $basename =~ TASK-([0-9]+)- ]]; then
                local num="${BASH_REMATCH[1]}"
                if ((num > max_num)); then
                    max_num=$num
                fi
            fi
        fi
    done
    printf "%03d" $((max_num + 1))
}

# Initialize new task
init_task() {
    local description="$1"
    if [[ -z "$description" ]]; then
        echo -e "${RED}Error: Task description required${NC}"
        echo "Usage: $0 init <description>"
        exit 1
    fi

    # Generate task ID
    local date=$(date +%Y%m%d)
    local task_num=$(get_next_task_number)
    local safe_desc=$(echo "$description" | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
    local task_name="${date}-TASK-${task_num}-${safe_desc}"
    local task_dir="$ACTIVE_DIR/$task_name"

    # Create directory
    mkdir -p "$task_dir"

    # Copy templates with task name
    cp "$TEMPLATES_DIR/template-plan.md" "$task_dir/plan.md"
    cp "$TEMPLATES_DIR/template-context.md" "$task_dir/context.md"
    cp "$TEMPLATES_DIR/template-tasks.md" "$task_dir/tasks.md"

    # Update placeholders in files (macOS-compatible sed)
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "s/\[Task Name\]/$description/g" "$task_dir"/*.md
        sed -i '' "s/TASK-###/TASK-${task_num}/g" "$task_dir"/*.md
        sed -i '' "s/YYYY-MM-DD/$(date +%Y-%m-%d)/g" "$task_dir"/*.md
        sed -i '' "s/YYYYMMDD/$date/g" "$task_dir"/*.md
    else
        sed -i "s/\[Task Name\]/$description/g" "$task_dir"/*.md
        sed -i "s/TASK-###/TASK-${task_num}/g" "$task_dir"/*.md
        sed -i "s/YYYY-MM-DD/$(date +%Y-%m-%d)/g" "$task_dir"/*.md
        sed -i "s/YYYYMMDD/$date/g" "$task_dir"/*.md
    fi

    echo -e "${GREEN}‚úÖ Created task: $task_name${NC}"
    echo -e "${BLUE}üìÅ Location: $task_dir${NC}"
    echo ""
    echo "Next steps:"
    echo "1. Fill in plan.md with your implementation plan"
    echo "2. Update context.md with initial decisions"
    echo "3. Break down tasks in tasks.md"
    echo ""
    echo -e "${YELLOW}Tip: Use 'dev-docs status' to see all active tasks${NC}"
}

# Show status of all active tasks
status() {
    echo -e "${BLUE}=== Active Tasks ===${NC}"
    local count=0
    for dir in "$ACTIVE_DIR"/*; do
        if [[ -d "$dir" ]]; then
            local basename=$(basename "$dir")
            if [[ "$basename" == "*" ]] || [[ "$basename" == ".gitkeep" ]]; then
                continue
            fi
            local task_name=$(basename "$dir")
            local context_file="$dir/context.md"
            local tasks_file="$dir/tasks.md"

            # Extract status from context.md
            local status="Unknown"
            if [[ -f "$context_file" ]]; then
                status=$(grep -E '\*\*Status:\*\*' "$context_file" | sed 's/.*\*\*Status:\*\* *//' | head -1 || echo "In Progress")
            fi

            # Count tasks
            local total_tasks=0
            local completed_tasks=0
            if [[ -f "$tasks_file" ]]; then
                total_tasks=$(grep -c "^- \[.\]" "$tasks_file" || echo 0)
                completed_tasks=$(grep -c "^- \[x\]" "$tasks_file" || echo 0)
            fi

            local progress=0
            if [[ $total_tasks -gt 0 ]]; then
                progress=$((completed_tasks * 100 / total_tasks))
            fi

            echo -e "${GREEN}üìã $task_name${NC}"
            echo "   Status: $status | Progress: $completed_tasks/$total_tasks ($progress%)"
            ((count++))
        fi
    done

    if [[ $count -eq 0 ]]; then
        echo "No active tasks found"
    fi
    echo ""
}

# Update context before autocompact
update() {
    local task_name="$1"

    if [[ -z "$task_name" ]]; then
        # Find most recent active task
        task_name=$(ls -t "$ACTIVE_DIR" | head -1)
        if [[ -z "$task_name" ]]; then
            echo -e "${RED}Error: No active tasks found${NC}"
            exit 1
        fi
    fi

    local task_dir="$ACTIVE_DIR/$task_name"
    if [[ ! -d "$task_dir" ]]; then
        # Try with full path
        task_dir="$ACTIVE_DIR/*-$task_name"
        task_dir=$(ls -d $task_dir 2>/dev/null | head -1)
        if [[ ! -d "$task_dir" ]]; then
            echo -e "${RED}Error: Task not found: $task_name${NC}"
            exit 1
        fi
    fi

    # Update timestamps (macOS-compatible sed)
    local timestamp=$(date +"%Y-%m-%d %H:%M")
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "s/\*\*Last Updated:\*\*.*/\*\*Last Updated:\*\* $timestamp/" "$task_dir/context.md"
        sed -i '' "s/\*\*Last Updated:\*\*.*/\*\*Last Updated:\*\* $timestamp/" "$task_dir/tasks.md"
    else
        sed -i "s/\*\*Last Updated:\*\*.*/\*\*Last Updated:\*\* $timestamp/" "$task_dir/context.md"
        sed -i "s/\*\*Last Updated:\*\*.*/\*\*Last Updated:\*\* $timestamp/" "$task_dir/tasks.md"
    fi

    echo -e "${GREEN}‚úÖ Updated timestamps for: $(basename "$task_dir")${NC}"
    echo ""
    echo "Remember to:"
    echo "1. Update context.md with recent decisions"
    echo "2. Mark completed tasks in tasks.md"
    echo "3. Add any blockers or issues discovered"
    echo "4. Commit changes before autocompact"
}

# Complete a task
complete() {
    local task_name="$1"

    if [[ -z "$task_name" ]]; then
        echo -e "${RED}Error: Task name required${NC}"
        echo "Usage: $0 complete <task-name>"
        exit 1
    fi

    local task_dir="$ACTIVE_DIR/*$task_name*"
    task_dir=$(ls -d $task_dir 2>/dev/null | head -1)

    if [[ ! -d "$task_dir" ]]; then
        echo -e "${RED}Error: Task not found: $task_name${NC}"
        exit 1
    fi

    # Update status (macOS-compatible sed)
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "s/\*\*Status:\*\*.*/\*\*Status:\*\* Complete/" "$task_dir/context.md"
    else
        sed -i "s/\*\*Status:\*\*.*/\*\*Status:\*\* Complete/" "$task_dir/context.md"
    fi

    # Move to completed
    mv "$task_dir" "$COMPLETED_DIR/"

    echo -e "${GREEN}‚úÖ Task completed and archived${NC}"
    echo -e "${BLUE}üìÅ Archived to: $COMPLETED_DIR/$(basename "$task_dir")${NC}"
}

# Search dev docs
search() {
    local pattern="$1"
    if [[ -z "$pattern" ]]; then
        echo -e "${RED}Error: Search pattern required${NC}"
        echo "Usage: $0 search <pattern>"
        exit 1
    fi

    echo -e "${BLUE}Searching for: '$pattern'${NC}"
    echo ""

    # Search in both active and completed
    grep -r "$pattern" "$ACTIVE_DIR" "$COMPLETED_DIR" --include="*.md" | \
        sed "s|$DEV_DIR/||g" | \
        head -20
}

# Show help
help() {
    echo "Dev Docs Helper - Manage development documentation"
    echo ""
    echo "Usage: $0 <command> [options]"
    echo ""
    echo "Commands:"
    echo "  init <description>   Create new task with description"
    echo "  status              Show all active tasks with progress"
    echo "  update [task]       Update timestamps (before autocompact)"
    echo "  complete <task>     Mark task complete and archive"
    echo "  search <pattern>    Search all dev docs for pattern"
    echo "  help                Show this help message"
    echo ""
    echo "Examples:"
    echo "  $0 init 'Add approval workflow'"
    echo "  $0 status"
    echo "  $0 update TASK-001"
    echo "  $0 complete approval-workflow"
    echo "  $0 search 'React Query'"
}

# Main command router
case "${1:-}" in
    init)
        init_task "$2"
        ;;
    status)
        status
        ;;
    update)
        update "$2"
        ;;
    complete)
        complete "$2"
        ;;
    search)
        search "$2"
        ;;
    help|--help|-h)
        help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        help
        exit 1
        ;;
esac