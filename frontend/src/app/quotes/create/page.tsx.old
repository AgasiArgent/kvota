'use client'

import React, { useState, useEffect } from 'react'
import {
  Form,
  Input,
  Select,
  Button,
  Card,
  Upload,
  Table,
  Typography,
  Row,
  Col,
  message,
  Collapse,
  InputNumber,
  Space,
  Divider,
  Spin,
  Tag,
  Checkbox,
} from 'antd'
import {
  UploadOutlined,
  InboxOutlined,
  SaveOutlined,
  CalculatorOutlined,
  DeleteOutlined,
  ArrowLeftOutlined,
} from '@ant-design/icons'
import { useRouter } from 'next/navigation'
import type { UploadFile, UploadProps } from 'antd'
import MainLayout from '@/components/layout/MainLayout'
import { quotesCalcService, Product, VariableTemplate, CalculationVariables } from '@/lib/api/quotes-calc-service'
import { customerService, Customer } from '@/lib/api/customer-service'

const { Title, Text } = Typography
const { Dragger } = Upload
const { Panel } = Collapse

export default function CreateQuotePage() {
  const router = useRouter()
  const [form] = Form.useForm<CalculationVariables>()

  // State
  const [loading, setLoading] = useState(false)
  const [uploadedProducts, setUploadedProducts] = useState<Product[]>([])
  const [uploadedFile, setUploadedFile] = useState<UploadFile | null>(null)
  const [customers, setCustomers] = useState<Customer[]>([])
  const [templates, setTemplates] = useState<VariableTemplate[]>([])
  const [selectedTemplate, setSelectedTemplate] = useState<string | undefined>()
  const [selectedCustomer, setSelectedCustomer] = useState<string | undefined>()
  const [calculationResults, setCalculationResults] = useState<any>(null)
  const [visibleColumns, setVisibleColumns] = useState<string[]>([])

  // Forms for each step
  const [basicForm] = Form.useForm()
  const [itemsForm] = Form.useForm()
  const [financialForm] = Form.useForm()
  const [workflowForm] = Form.useForm()

  // State
  const [customers, setCustomers] = useState<Customer[]>([])
  const [items, setItems] = useState<QuoteItem[]>([])
  const [selectedCustomer, setSelectedCustomer] = useState<Customer | null>(null)
  const [subtotal, setSubtotal] = useState(0)
  const [total, setTotal] = useState(0)

  const quoteService = new QuoteService()
  const customerService = new BaseApiService<Customer>('customers')

  // Load customers on mount
  React.useEffect(() => {
    fetchCustomers()
  }, [])

  // Recalculate totals when items or financial settings change
  React.useEffect(() => {
    calculateTotals()
  }, [items])

  const fetchCustomers = async () => {
    try {
      const response = await customerService.getAll({ page: 1, page_size: 100 })
      setCustomers(response.data)
    } catch (error: any) {
      message.error(`Ошибка загрузки клиентов: ${error.message}`)
    }
  }

  const calculateTotals = () => {
    const sub = items.reduce((sum, item) => sum + item.line_total, 0)
    setSubtotal(sub)

    // Get financial values
    const discountType = financialForm.getFieldValue('discount_type') || 'percentage'
    const discountValue = financialForm.getFieldValue('discount_value') || 0
    const vatRate = financialForm.getFieldValue('vat_rate') || 20
    const importDutyRate = financialForm.getFieldValue('import_duty_rate') || 0
    const creditRate = financialForm.getFieldValue('credit_rate') || 0

    // Calculate
    const discount = discountType === 'percentage'
      ? sub * (discountValue / 100)
      : discountValue
    const afterDiscount = sub - discount
    const vat = afterDiscount * (vatRate / 100)
    const importDuty = afterDiscount * (importDutyRate / 100)
    const credit = (afterDiscount + vat + importDuty) * (creditRate / 100)

    setTotal(afterDiscount + vat + importDuty + credit)
  }

  const handleAddItem = () => {
    itemsForm.validateFields(['description', 'quantity', 'unit', 'unit_price']).then(values => {
      const newItem: QuoteItem = {
        key: Date.now().toString(),
        description: values.description,
        product_code: values.product_code,
        quantity: values.quantity,
        unit: values.unit,
        unit_price: values.unit_price,
        line_total: values.quantity * values.unit_price,
      }
      setItems([...items, newItem])
      itemsForm.resetFields(['description', 'product_code', 'quantity', 'unit', 'unit_price'])
    })
  }

  const handleDeleteItem = (key: string) => {
    setItems(items.filter(item => item.key !== key))
  }

  const handleNext = async () => {
    try {
      if (currentStep === 0) {
        await basicForm.validateFields()
      } else if (currentStep === 1) {
        if (items.length === 0) {
          message.warning('Добавьте хотя бы одну позицию')
          return
        }
      } else if (currentStep === 2) {
        await financialForm.validateFields()
        calculateTotals()
      }
      setCurrentStep(currentStep + 1)
    } catch (error) {
      message.error('Заполните все обязательные поля')
    }
  }

  const handlePrevious = () => {
    setCurrentStep(currentStep - 1)
  }

  const handleSubmit = async (asDraft: boolean = false) => {
    setLoading(true)
    try {
      // Validate final step
      await workflowForm.validateFields()

      // Gather all data
      const basicValues = basicForm.getFieldsValue()
      const financialValues = financialForm.getFieldsValue()
      const workflowValues = workflowForm.getFieldsValue()

      const quoteData = {
        customer_id: basicValues.customer_id,
        title: basicValues.title,
        description: basicValues.description,
        currency: basicValues.currency,
        quote_date: basicValues.quote_date.format('YYYY-MM-DD'),
        valid_until: basicValues.valid_until?.format('YYYY-MM-DD'),
        payment_terms: basicValues.payment_terms,

        // Items
        items: items.map(item => ({
          description: item.description,
          product_code: item.product_code,
          quantity: item.quantity,
          unit: item.unit,
          unit_price: item.unit_price,
        })),

        // Financial
        discount_type: financialValues.discount_type,
        discount_rate: financialValues.discount_type === 'percentage' ? financialValues.discount_value : 0,
        discount_amount: financialValues.discount_type === 'fixed' ? financialValues.discount_value : 0,
        vat_rate: financialValues.vat_rate,
        import_duty_rate: financialValues.import_duty_rate || 0,
        credit_rate: financialValues.credit_rate || 0,

        // Workflow
        requires_approval: !asDraft && workflowValues.requires_approval,
        approval_type: workflowValues.approval_type,
        notes: workflowValues.notes,
        internal_notes: workflowValues.internal_notes,

        // Status
        status: asDraft ? 'draft' : (workflowValues.requires_approval ? 'pending_approval' : 'approved'),
      }

      const createdQuote = await quoteService.create(quoteData)

      message.success(asDraft ? 'КП сохранено как черновик' : 'КП успешно создано')
      router.push(`/quotes/${createdQuote.id}`)
    } catch (error: any) {
      message.error(`Ошибка создания КП: ${error.message}`)
    } finally {
      setLoading(false)
    }
  }

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('ru-RU', {
      style: 'currency',
      currency: basicForm.getFieldValue('currency') || 'RUB',
      minimumFractionDigits: 2,
    }).format(amount)
  }

  const itemColumns = [
    {
      title: 'Наименование',
      dataIndex: 'description',
      key: 'description',
      ellipsis: true,
    },
    {
      title: 'Артикул',
      dataIndex: 'product_code',
      key: 'product_code',
      width: 120,
    },
    {
      title: 'Кол-во',
      dataIndex: 'quantity',
      key: 'quantity',
      width: 80,
      render: (qty: number, record: QuoteItem) => `${qty} ${record.unit}`,
    },
    {
      title: 'Цена',
      dataIndex: 'unit_price',
      key: 'unit_price',
      width: 120,
      align: 'right' as const,
      render: (price: number) => formatCurrency(price),
    },
    {
      title: 'Сумма',
      dataIndex: 'line_total',
      key: 'line_total',
      width: 120,
      align: 'right' as const,
      render: (total: number) => <Text strong>{formatCurrency(total)}</Text>,
    },
    {
      title: '',
      key: 'actions',
      width: 60,
      render: (_: any, record: QuoteItem) => (
        <Button
          type="text"
          danger
          icon={<DeleteOutlined />}
          onClick={() => handleDeleteItem(record.key)}
        />
      ),
    },
  ]

  const steps = [
    { title: 'Основная информация' },
    { title: 'Позиции' },
    { title: 'Финансовые условия' },
    { title: 'Утверждение и отправка' },
  ]

  return (
    <MainLayout>
      <Space direction="vertical" size="large" style={{ width: '100%' }}>
        {/* Header */}
        <Row justify="space-between" align="middle">
          <Col>
            <Space>
              <Button
                icon={<ArrowLeftOutlined />}
                onClick={() => router.push('/quotes')}
              >
                Назад
              </Button>
              <Title level={2} style={{ margin: 0 }}>
                Создать коммерческое предложение
              </Title>
            </Space>
          </Col>
        </Row>

        {/* Steps */}
        <Card>
          <Steps current={currentStep} items={steps} />
        </Card>

        {/* Step Content */}
        {currentStep === 0 && (
          <Card title="Основная информация">
            <Form
              form={basicForm}
              layout="vertical"
              initialValues={{
                currency: 'RUB',
                payment_terms: 30,
                quote_date: dayjs(),
                valid_until: dayjs().add(30, 'day'),
              }}
            >
              <Row gutter={16}>
                <Col xs={24} md={12}>
                  <Form.Item
                    name="customer_id"
                    label="Клиент"
                    rules={[{ required: true, message: 'Выберите клиента' }]}
                  >
                    <Select
                      size="large"
                      showSearch
                      placeholder="Выберите клиента"
                      optionFilterProp="children"
                      onChange={(value) => {
                        const customer = customers.find(c => c.id === value)
                        setSelectedCustomer(customer || null)
                        if (customer) {
                          basicForm.setFieldValue('payment_terms', customer.payment_terms)
                        }
                      }}
                      options={customers.map(c => ({
                        label: c.name,
                        value: c.id,
                      }))}
                      dropdownRender={(menu) => (
                        <>
                          {menu}
                          <Divider style={{ margin: '8px 0' }} />
                          <Button
                            type="link"
                            icon={<PlusOutlined />}
                            onClick={() => router.push('/customers/create')}
                            block
                          >
                            Добавить нового клиента
                          </Button>
                        </>
                      )}
                    />
                  </Form.Item>
                </Col>

                <Col xs={24} md={12}>
                  <Form.Item
                    name="title"
                    label="Название КП"
                    rules={[{ required: true, message: 'Введите название' }]}
                  >
                    <Input size="large" placeholder="Поставка оборудования" />
                  </Form.Item>
                </Col>

                <Col xs={24}>
                  <Form.Item name="description" label="Описание">
                    <TextArea rows={3} placeholder="Краткое описание коммерческого предложения..." />
                  </Form.Item>
                </Col>

                <Col xs={24} md={8}>
                  <Form.Item
                    name="currency"
                    label="Валюта"
                    rules={[{ required: true }]}
                  >
                    <Select
                      size="large"
                      options={[
                        { label: 'RUB - Российский рубль', value: 'RUB' },
                        { label: 'USD - Доллар США', value: 'USD' },
                        { label: 'EUR - Евро', value: 'EUR' },
                        { label: 'CNY - Китайский юань', value: 'CNY' },
                      ]}
                    />
                  </Form.Item>
                </Col>

                <Col xs={24} md={8}>
                  <Form.Item
                    name="quote_date"
                    label="Дата КП"
                    rules={[{ required: true }]}
                  >
                    <DatePicker size="large" style={{ width: '100%' }} format="DD.MM.YYYY" />
                  </Form.Item>
                </Col>

                <Col xs={24} md={8}>
                  <Form.Item name="valid_until" label="Действительно до">
                    <DatePicker size="large" style={{ width: '100%' }} format="DD.MM.YYYY" />
                  </Form.Item>
                </Col>

                <Col xs={24} md={12}>
                  <Form.Item
                    name="payment_terms"
                    label="Условия оплаты (дней)"
                    rules={[{ required: true }]}
                  >
                    <InputNumber
                      size="large"
                      style={{ width: '100%' }}
                      min={0}
                      max={365}
                      addonAfter="дней"
                    />
                  </Form.Item>
                </Col>
              </Row>
            </Form>
          </Card>
        )}

        {currentStep === 1 && (
          <Card title="Позиции">
            <Space direction="vertical" size="large" style={{ width: '100%' }}>
              {/* Add Item Form */}
              <Card title="Добавить позицию" size="small">
                <Form form={itemsForm} layout="vertical">
                  <Row gutter={16}>
                    <Col xs={24} md={10}>
                      <Form.Item
                        name="description"
                        label="Наименование"
                        rules={[{ required: true, message: 'Введите наименование' }]}
                      >
                        <Input placeholder="Описание товара или услуги" />
                      </Form.Item>
                    </Col>
                    <Col xs={12} md={4}>
                      <Form.Item name="product_code" label="Артикул">
                        <Input placeholder="ABC-123" />
                      </Form.Item>
                    </Col>
                    <Col xs={12} md={3}>
                      <Form.Item
                        name="quantity"
                        label="Количество"
                        rules={[{ required: true, message: 'Кол-во' }]}
                        initialValue={1}
                      >
                        <InputNumber min={0.001} style={{ width: '100%' }} />
                      </Form.Item>
                    </Col>
                    <Col xs={12} md={3}>
                      <Form.Item
                        name="unit"
                        label="Ед. изм."
                        rules={[{ required: true, message: 'Ед.' }]}
                        initialValue="шт"
                      >
                        <Select
                          options={[
                            { label: 'шт', value: 'шт' },
                            { label: 'кг', value: 'кг' },
                            { label: 'м', value: 'м' },
                            { label: 'м²', value: 'м²' },
                            { label: 'м³', value: 'м³' },
                            { label: 'л', value: 'л' },
                            { label: 'упак', value: 'упак' },
                          ]}
                        />
                      </Form.Item>
                    </Col>
                    <Col xs={12} md={4}>
                      <Form.Item
                        name="unit_price"
                        label="Цена за ед."
                        rules={[{ required: true, message: 'Цена' }]}
                      >
                        <InputNumber
                          min={0}
                          style={{ width: '100%' }}
                          formatter={(value) => `${value}`.replace(/\B(?=(\d{3})+(?!\d))/g, ' ')}
                          parser={(value) => value?.replace(/\s/g, '') as any}
                        />
                      </Form.Item>
                    </Col>
                  </Row>
                  <Button type="dashed" icon={<PlusOutlined />} onClick={handleAddItem} block>
                    Добавить позицию
                  </Button>
                </Form>
              </Card>

              {/* File Upload Option */}
              <Card title="Или загрузите из файла" size="small">
                <Upload
                  accept=".xlsx,.xls,.csv"
                  beforeUpload={() => {
                    message.info('Загрузка файлов будет доступна после интеграции')
                    return false
                  }}
                  maxCount={1}
                >
                  <Button icon={<UploadOutlined />}>
                    Загрузить Excel/CSV (скоро)
                  </Button>
                </Upload>
                <Text type="secondary" style={{ marginLeft: 8 }}>
                  Поддерживаются форматы: .xlsx, .xls, .csv
                </Text>
              </Card>

              {/* Items Table */}
              {items.length > 0 && (
                <Table
                  columns={itemColumns}
                  dataSource={items}
                  pagination={false}
                  summary={() => (
                    <Table.Summary fixed>
                      <Table.Summary.Row>
                        <Table.Summary.Cell index={0} colSpan={4} align="right">
                          <Text strong>Подытог:</Text>
                        </Table.Summary.Cell>
                        <Table.Summary.Cell index={1} align="right">
                          <Text strong style={{ fontSize: '16px' }}>
                            {formatCurrency(subtotal)}
                          </Text>
                        </Table.Summary.Cell>
                        <Table.Summary.Cell index={2} />
                      </Table.Summary.Row>
                    </Table.Summary>
                  )}
                />
              )}

              {items.length === 0 && (
                <Card>
                  <Text type="secondary">Позиции не добавлены. Добавьте позиции вручную или загрузите из файла.</Text>
                </Card>
              )}
            </Space>
          </Card>
        )}

        {currentStep === 2 && (
          <Card title="Финансовые условия">
            <Form
              form={financialForm}
              layout="vertical"
              initialValues={{
                discount_type: 'percentage',
                discount_value: 0,
                vat_rate: 20,
                import_duty_rate: 0,
                credit_rate: 0,
              }}
              onValuesChange={calculateTotals}
            >
              <Row gutter={16}>
                <Col xs={24} md={12}>
                  <Card title="Скидка" size="small">
                    <Form.Item name="discount_type" label="Тип скидки">
                      <Select
                        options={[
                          { label: 'Процент', value: 'percentage' },
                          { label: 'Фиксированная сумма', value: 'fixed' },
                        ]}
                      />
                    </Form.Item>
                    <Form.Item name="discount_value" label="Значение скидки">
                      <InputNumber
                        min={0}
                        style={{ width: '100%' }}
                        addonAfter={financialForm.getFieldValue('discount_type') === 'percentage' ? '%' : basicForm.getFieldValue('currency')}
                      />
                    </Form.Item>
                  </Card>
                </Col>

                <Col xs={24} md={12}>
                  <Card title="Налоги и пошлины" size="small">
                    <Form.Item name="vat_rate" label="Ставка НДС (%)">
                      <Select
                        options={[
                          { label: '20% (стандартная)', value: 20 },
                          { label: '10% (льготная)', value: 10 },
                          { label: '0% (без НДС)', value: 0 },
                        ]}
                      />
                    </Form.Item>
                    <Form.Item name="import_duty_rate" label="Импортная пошлина (%)">
                      <InputNumber
                        min={0}
                        max={100}
                        style={{ width: '100%' }}
                        addonAfter="%"
                      />
                    </Form.Item>
                    <Form.Item name="credit_rate" label="Стоимость кредита (%)">
                      <InputNumber
                        min={0}
                        max={100}
                        style={{ width: '100%' }}
                        addonAfter="%"
                      />
                    </Form.Item>
                  </Card>
                </Col>

                <Col xs={24}>
                  <Card title="Итоговый расчет">
                    <Space direction="vertical" style={{ width: '100%' }}>
                      <Row justify="space-between">
                        <Text>Подытог:</Text>
                        <Text strong>{formatCurrency(subtotal)}</Text>
                      </Row>
                      {financialForm.getFieldValue('discount_value') > 0 && (
                        <Row justify="space-between">
                          <Text>Скидка:</Text>
                          <Text type="danger">
                            -{formatCurrency(
                              financialForm.getFieldValue('discount_type') === 'percentage'
                                ? subtotal * (financialForm.getFieldValue('discount_value') / 100)
                                : financialForm.getFieldValue('discount_value')
                            )}
                          </Text>
                        </Row>
                      )}
                      <Row justify="space-between">
                        <Text>НДС ({financialForm.getFieldValue('vat_rate')}%):</Text>
                        <Text>{formatCurrency((subtotal - (financialForm.getFieldValue('discount_type') === 'percentage' ? subtotal * (financialForm.getFieldValue('discount_value') / 100) : financialForm.getFieldValue('discount_value'))) * (financialForm.getFieldValue('vat_rate') / 100))}</Text>
                      </Row>
                      <Divider style={{ margin: '8px 0' }} />
                      <Row justify="space-between">
                        <Text strong style={{ fontSize: '18px' }}>Итого:</Text>
                        <Text strong style={{ fontSize: '18px', color: '#1890ff' }}>
                          {formatCurrency(total)}
                        </Text>
                      </Row>
                    </Space>
                  </Card>
                </Col>
              </Row>
            </Form>
          </Card>
        )}

        {currentStep === 3 && (
          <Card title="Утверждение и отправка">
            <Form
              form={workflowForm}
              layout="vertical"
              initialValues={{
                requires_approval: true,
                approval_type: 'sequential',
              }}
            >
              <Row gutter={16}>
                <Col xs={24} md={12}>
                  <Card title="Процесс утверждения" size="small">
                    <Form.Item name="requires_approval" label="Требуется утверждение" valuePropName="checked">
                      <Select
                        options={[
                          { label: 'Да, отправить на утверждение', value: true },
                          { label: 'Нет, утвердить автоматически', value: false },
                        ]}
                      />
                    </Form.Item>

                    <Form.Item name="approval_type" label="Тип утверждения">
                      <Select
                        options={[
                          { label: 'Последовательное (по порядку)', value: 'sequential' },
                          { label: 'Параллельное (одновременно)', value: 'parallel' },
                        ]}
                      />
                    </Form.Item>

                    <Text type="secondary" style={{ fontSize: '12px' }}>
                      * Утверждающие будут назначены автоматически на основе суммы КП и правил компании
                    </Text>
                  </Card>
                </Col>

                <Col xs={24} md={12}>
                  <Card title="Примечания" size="small">
                    <Form.Item name="notes" label="Примечания для клиента">
                      <TextArea rows={4} placeholder="Условия доставки, гарантии и т.д." />
                    </Form.Item>
                    <Form.Item name="internal_notes" label="Внутренние примечания">
                      <TextArea rows={4} placeholder="Заметки для команды (не видны клиенту)" />
                    </Form.Item>
                  </Card>
                </Col>

                <Col xs={24}>
                  <Card title="Сводка">
                    <Row gutter={16}>
                      <Col xs={12} md={6}>
                        <Text type="secondary">Клиент:</Text>
                        <br />
                        <Text strong>{selectedCustomer?.name || '—'}</Text>
                      </Col>
                      <Col xs={12} md={6}>
                        <Text type="secondary">Позиций:</Text>
                        <br />
                        <Text strong>{items.length}</Text>
                      </Col>
                      <Col xs={12} md={6}>
                        <Text type="secondary">Валюта:</Text>
                        <br />
                        <Text strong>{basicForm.getFieldValue('currency')}</Text>
                      </Col>
                      <Col xs={12} md={6}>
                        <Text type="secondary">Итоговая сумма:</Text>
                        <br />
                        <Text strong style={{ fontSize: '16px', color: '#1890ff' }}>
                          {formatCurrency(total)}
                        </Text>
                      </Col>
                    </Row>
                  </Card>
                </Col>
              </Row>
            </Form>
          </Card>
        )}

        {/* Navigation */}
        <Card>
          <Row justify="space-between">
            <Col>
              {currentStep > 0 && (
                <Button size="large" onClick={handlePrevious}>
                  Назад
                </Button>
              )}
            </Col>
            <Col>
              <Space>
                {currentStep < 3 && (
                  <Button type="primary" size="large" onClick={handleNext}>
                    Далее
                  </Button>
                )}
                {currentStep === 3 && (
                  <>
                    <Button
                      size="large"
                      icon={<SaveOutlined />}
                      onClick={() => handleSubmit(true)}
                      loading={loading}
                    >
                      Сохранить как черновик
                    </Button>
                    <Button
                      type="primary"
                      size="large"
                      icon={<CheckOutlined />}
                      onClick={() => handleSubmit(false)}
                      loading={loading}
                    >
                      {workflowForm.getFieldValue('requires_approval')
                        ? 'Отправить на утверждение'
                        : 'Создать КП'}
                    </Button>
                  </>
                )}
              </Space>
            </Col>
          </Row>
        </Card>
      </Space>
    </MainLayout>
  )
}
