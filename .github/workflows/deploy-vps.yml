name: Deploy Backend to VPS

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'Dockerfile'
      - 'docker-compose.yml'
  workflow_dispatch:  # Manual trigger button

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Notify Telegram - Deployment Started
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="üöÄ *Kvota Backend* deployment started...%0A%0ACommit: \`${{ github.sha }}\`%0ABranch: ${{ github.ref_name }}" \
            -d parse_mode=Markdown

      - name: Deploy via SSH
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            echo "üöÄ Starting deployment..."
            cd /root/lisa

            # Update kvota-backend submodule to latest main
            echo "üì¶ Updating kvota-backend submodule..."
            cd kvota-backend
            git fetch origin main
            git checkout main
            git pull origin main
            cd ..

            # Rebuild and restart container (using override file)
            echo "üî® Building container..."
            docker compose -f docker-compose.yml -f docker-compose.override.kvota.yml build kvota-backend --no-cache

            echo "üîÑ Restarting container..."
            docker compose -f docker-compose.yml -f docker-compose.override.kvota.yml up -d kvota-backend --no-deps

            # Show status
            docker ps | grep kvota
            echo "‚úÖ Deployment complete!"

      - name: Notify Telegram - Success
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="‚úÖ *Kvota Backend* deployed successfully!%0A%0Aüîó https://api.kvotaflow.ru" \
            -d parse_mode=Markdown

      - name: Notify Telegram - Failure
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="‚ùå *Kvota Backend* deployment FAILED!%0A%0ACheck: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            -d parse_mode=Markdown
